<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Heatmap Viewer</title>

    <script src="https://unpkg.com/maplibre-gl@4.3.2/dist/maplibre-gl.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.3.2/dist/maplibre-gl.css" />

    <script src="/static/main.js"></script>
</head>

<body>
    <style>
        html {
            box-sizing: border-box;
        }

        *,
        *:before,
        *:after {
            box-sizing: inherit;
            border: 0 solid #e5e7eb;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, sans-serif;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        #map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            padding: 0.5em 1em;
            margin: 1em;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            border-radius: 2.5%;
            border: 1px solid white;
            width: 25ch;

            summary {
                cursor: pointer;
                user-select: none;
            }

            label {
                display: inline-block;
                width: 40%;
            }

            select,
            input {
                width: 50%;
                font-family: system-ui, sans-serif;
            }
        }

        #map-overlay>details>div {
            padding: 0.5em;
        }

        .drop-area {
            .__target {
                height: 10ch;
                border-width: 1px;
                border-radius: 1em;
                margin: 1em 0;
                transition: background-color 300ms;

                &.--highlight {
                    background-color: lightgrey;
                }

                label {
                    text-align: center;
                    height: 100%;
                    width: 100%;
                    color: gray;
                    cursor: copy;
                    display: flex;
                    flex-direction: column;
                    align-content: center;
                    justify-content: center;
                    position: relative;
                }

                .__progress {
                    width: 0px;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.15);
                    transition: opacity 1s;
                    position: absolute;
                    top: 0;
                    left: 0;
                    border-radius: 1em;
                }
            }

            .__results {
                color: gray;
                font-size: small;
                height: 100px;
                overflow-y: scroll;
                display: none;

                .__row {
                    display: grid;

                    &.--success {
                        grid-template-columns: 1fr;

                        .__file::before {
                            content: "✓ ";
                        }
                    }

                    &.--error {
                        grid-template-columns: 30% 1fr;
                        grid-gap: 1em;
                        background-color: rgb(255, 0, 0, 0.2);

                        .__file::before {
                            content: "❌ ";
                        }
                    }

                    .__file {
                        white-space: nowrap;
                        text-overflow: ellipsis;
                        overflow: hidden;
                    }
                }
            }
        }
    </style>

    <template id="template-modal">
        <style>
            html {
                box-sizing: border-box;
            }

            *,
            *:before,
            *:after {
                box-sizing: inherit;
                border: 0 solid #d4d6da;
            }

            .modal {
                width: 100vw;
                height: 100vh;
                background-color: rgba(0, 0, 0, 0.75);
                z-index: 999;
                position: fixed;
                top: 0;
                left: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .modal__content {
                background-color: white;
                margin: 0 auto;
                width: 45ch;
                border-radius: 0.5em;
                display: flex;
                flex-direction: column;
                padding: 1em 2em;
            }

            .modal__header {
                text-align: center;
            }

            .modal__body {
                flex-grow: 1;
            }

            .modal__footer {
                display: flex;
                flex-direction: row-reverse;
                margin-top: 1em;
            }

            .modal__footer_button {
                background-color: transparent;
                padding: 0.5em;
                border-radius: 0.25em;
                border-width: 1px;
                cursor: pointer;
            }

            .modal__footer_button:hover {
                background-color: rgba(179, 179, 179, 0.15);
            }
        </style>

        <dialog class="modal" open>
            <div class="modal__content">
                <div class="modal__header">
                    <div name="header">
                        <slot name="header"></slot>
                    </div>
                </div>
                <div class="modal__body">
                    <div name="body">
                        <slot name="body"></slot>
                    </div>
                </div>
                <div class="modal__footer">
                    <form method="dialog">
                        <button class="modal__footer_button">Close</button>
                    </form>
                </div>
            </div>
        </dialog>
    </template>

    <div id="map"></div>
    <div id="map-overlay">
        <details>
            <summary>
                <b>Settings</b>
            </summary>

            <div>
                <label for="after">After</label>
                <input key="after" type="date" name="after" id="after" value="" />
            </div>

            <div>
                <label for="before">Before</label>
                <input key="before" type="date" name="before" id="before" value="" />
            </div>

            <div>
                <label for="color">Theme</label>
                <select key="color" name="color">
                    <option value="pinkish" selected>Pinkish</option>
                    <option value="orange">Orange</option>
                    <option value="blue-red">Blue/Red</option>
                    <option value="red">Red</option>
                </select>
            </div>

            <div>
                <label for="size">Tile Size</label>
                <select key="size" name="size">
                    <option value="256">256</option>
                    <option value="512" selected>512</option>
                </select>
            </div>

            <div>
                <label for="map">Base Map</label>
                <select key="map" name="map">
                    <option value="dark-matter-nolabels" selected>
                        Dark (no labels)
                    </option>
                    <option value="positron-nolabels">Light (no labels)</option>
                    <option value="dark-matter">Dark</option>
                    <option value="positron">Light</option>
                </select>
            </div>

            <div>
                <label for="filter">Filter</label>
                <input key="filter" name="filter" />
            </div>

            <div>
                <label for="gradient">Gradient</label>
                <input key="gradient" name="gradient" />
            </div>
        </details>
    </div>

    <script>
        const map = new maplibregl.Map({
            container: "map",
            style: "https://basemaps.cartocdn.com/gl/dark-matter-nolabels-gl-style/style.json",
            center: [0, 0],
            hash: true,
        });

        const options = livewire({
            color: null,
            before: null,
            after: null,
            size: "512",
            map: "dark-matter-nolabels",
            filter: null,
            gradient: null,

            // Prioritize custom gradient if available
            $color: ({ color, gradient }) => (!!gradient?.trim() ? null : color),
            $styleUrl: ({ map }) => `https://basemaps.cartocdn.com/gl/${map}-gl-style/style.json`,
            $tileUrl: ({ before, after, filter, gradient, $color }) => {
                let qs = [
                    before && `before=${before}`,
                    after && `after=${after}`,
                    filter && `filter=${filter}`,
                    gradient && `gradient=${gradient}`,
                    $color && `color=${$color}`,
                ]
                    .filter((it) => !!it)
                    .join("&");

                return "/tile/{z}/{x}/{y}{ratio}?" + qs;
            },
        }).watch(({ $styleUrl }) => {
            map.setStyle($styleUrl);
            map.once("styledata", () => updateSource());
        });

        document.querySelectorAll("#map-overlay [key]").forEach((el) => {
            const key = el.getAttribute("key");
            el.addEventListener("change", (ev) => {
                options[key] = ev.target.value;
            });
        });

        function updateSource() {
            if (typeof map.getSource("hotpot") !== "undefined") {
                map.removeLayer("hotpot");
                map.removeSource("hotpot");
            }

            map
                .addSource("hotpot", {
                    type: "raster",
                    tiles: [options.$tileUrl],
                    tileSize: +options.size,
                    minZoom: 0,
                    maxZoom: 16,
                })
                .addLayer({
                    id: "hotpot",
                    type: "raster",
                    source: "hotpot",
                    minZoom: 0,
                });
        }

        map.on("load", () => updateSource());
        map.addControl(new maplibregl.NavigationControl());
        map.addControl(new UploadButton(), "top-right");
    </script>
</body>

</html>